# CI: lint, build, and test on every push and pull request.
#
# Integration tests (real Gemini API calls) only run on Node 22.
# Node 18/20 run protocol-only tests to avoid hangs with --use-env-proxy.
#
# Required secrets (Settings → Secrets → Actions):
#   GEMINI_API_KEY - enables integration tests against the real Gemini API

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/enhanced-stdio-server.js || { echo "::error::dist/enhanced-stdio-server.js not found"; exit 1; }
          head -1 dist/enhanced-stdio-server.js | grep -q '#!/usr/bin/env node' || { echo "::error::Missing shebang"; exit 1; }

      # Integration tests only on Node 22 — older versions hang with --use-env-proxy.
      # Node 18/20 still run the full protocol test suite (no API key → integration tests auto-skip).
      - name: Run tests
        env:
          GEMINI_API_KEY: ${{ matrix.node-version == 22 && secrets.GEMINI_API_KEY || '' }}
        run: npm test
